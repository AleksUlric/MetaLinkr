# ELK轻量级日志纳管方案设计

## 1. 方案概述

### 1.1 设计理念
基于当前项目的Kafka日志收集基础，设计一个轻量级的ELK日志纳管方案，采用单体部署模式，使用Filebeat替代重量级的Logstash，实现资源占用最小化。

### 1.2 核心特点
- **轻量级**: 总内存占用约1.1GB
- **单体部署**: 单节点Elasticsearch，简化运维
- **Filebeat收集**: 替代Logstash，资源占用更少
- **快速部署**: 一键启动，开箱即用
- **开发友好**: 禁用安全功能，简化配置

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    ELK轻量级架构                                │
└─────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 应用服务     │    │ 日志收集     │    │ 日志存储     │    │ 日志查询     │
│             │    │             │    │             │    │             │
│ linkr-server│    │  Filebeat   │    │Elasticsearch│    │   Kibana    │
│ nacos-server│───▶│  (轻量级)    │───▶│ (单节点)     │───▶│ (可视化)     │
│ 其他服务     │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   │
   ┌───▼───┐           ┌───▼───┐           ┌───▼───┐           ┌───▼───┐
   │ 文件日志│           │ 实时收集│           │ 索引存储│           │ 查询分析│
   │ 容器日志│           │ 解析处理│           │ 全文搜索│           │ 可视化│
   └───────┘           └───────┘           └───────┘           └───────┘
```

### 2.2 组件说明

#### 日志收集层 - Filebeat
- **轻量级**: 内存占用约100MB
- **多源收集**: 支持文件日志、容器日志、系统日志
- **实时处理**: 流式处理，低延迟
- **直接输出**: 直接发送到Elasticsearch，无需中间件

#### 日志存储层 - Elasticsearch
- **单节点**: 512MB内存配置
- **高性能**: 支持全文搜索和聚合分析
- **索引管理**: 按时间自动分片
- **生命周期**: 自动清理过期数据

#### 日志查询层 - Kibana
- **可视化**: 丰富的图表和仪表板
- **查询界面**: 友好的查询界面
- **实时监控**: 实时日志流展示
- **中文支持**: 完整的中文界面

## 3. 资源规划

### 3.1 内存配置

| 组件 | 内存配置 | 说明 |
|------|----------|------|
| Elasticsearch | 512MB | 单节点，适合开发环境 |
| Kibana | 512MB | 轻量级配置 |
| Filebeat | 100MB | 轻量级日志收集 |
| **总计** | **1.1GB** | 适合开发和小规模生产 |

### 3.2 存储规划

| 数据类型 | 保留期 | 存储量估算 |
|----------|--------|------------|
| 应用日志 | 7天 | 约100MB/天 |
| 系统日志 | 3天 | 约50MB/天 |
| 容器日志 | 3天 | 约200MB/天 |
| **总计** | **7天** | **约2.5GB** |

### 3.3 网络配置

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| Elasticsearch | 9200 | HTTP | REST API |
| Elasticsearch | 9300 | TCP | 节点通信 |
| Kibana | 5601 | HTTP | Web界面 |

## 4. 日志收集策略

### 4.1 收集范围

#### 应用日志
- **linkr-server日志**: 业务应用日志
- **admin-module日志**: 管理模块日志
- **log-module日志**: 日志模块日志

#### 系统日志
- **Nacos日志**: 注册中心日志
- **MySQL日志**: 数据库日志（可选）
- **Docker日志**: 容器运行日志

#### 访问日志
- **Web访问日志**: HTTP请求日志
- **API调用日志**: 接口调用日志

### 4.2 收集方式

#### 文件日志收集
```yaml
- type: log
  paths:
    - /var/log/app/*.log
    - /var/log/app/*.error.log
  fields:
    logtype: application
    service: linkr-server
```

#### 容器日志收集
```yaml
- type: container
  paths:
    - '/var/lib/docker/containers/*/*.log'
  fields:
    logtype: docker
```

#### 系统日志收集
```yaml
- type: log
  paths:
    - /var/log/nacos/*.log
  fields:
    logtype: nacos
    service: nacos-server
```

## 5. 数据处理流程

### 5.1 数据流设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据处理流程                             │
└─────────────────────────────────────────────────────────────────┘

1. 日志产生:
应用服务 → 日志文件 → 文件系统

2. 日志收集:
Filebeat → 文件监控 → 实时读取 → 解析处理

3. 日志传输:
Filebeat → Elasticsearch → 索引存储

4. 日志查询:
用户 → Kibana → Elasticsearch → 返回结果

5. 数据生命周期:
热数据(7天) → 自动删除
```

### 5.2 处理步骤

#### 解析阶段
- **多行日志**: 自动识别多行日志格式
- **时间解析**: 统一时间戳格式
- **字段提取**: 提取关键字段信息

#### 丰富阶段
- **服务标识**: 自动添加服务名称
- **日志类型**: 标识日志类型
- **主机信息**: 添加主机元数据
- **容器信息**: 添加Docker元数据

#### 过滤阶段
- **数据清洗**: 去除无效数据
- **字段标准化**: 统一字段格式
- **敏感信息**: 自动脱敏处理

## 6. 索引策略设计

### 6.1 索引命名

#### 时间分片策略
- **索引格式**: `filebeat-YYYY.MM.DD`
- **分片策略**: 按天分片
- **示例**: `filebeat-2024.01.15`

#### 索引配置
```yaml
template.settings:
  index.number_of_shards: 1      # 单分片
  index.number_of_replicas: 0    # 无副本
  index.refresh_interval: 5s     # 5秒刷新
```

### 6.2 生命周期管理

#### 数据保留策略
- **热数据**: 7天，快速查询
- **自动删除**: 超过7天自动删除
- **存储优化**: 压缩存储，节省空间

#### 清理策略
```bash
# 自动清理脚本
curl -X DELETE "localhost:9200/filebeat-$(date -d '7 days ago' '+%Y.%m.%d')"
```

## 7. 查询和可视化

### 7.1 查询功能

#### 基础查询
- **全文搜索**: 支持模糊匹配
- **字段过滤**: 按服务、级别、时间过滤
- **时间范围**: 支持相对时间和绝对时间
- **排序分页**: 按时间排序，支持分页

#### 高级查询
- **聚合分析**: 统计、分组、趋势分析
- **复杂条件**: 支持AND/OR/NOT逻辑
- **保存查询**: 保存常用查询条件

### 7.2 可视化功能

#### 图表展示
- **时间序列图**: 日志数量趋势
- **饼图**: 日志级别分布
- **柱状图**: 服务日志统计
- **热力图**: 错误分布热力图

#### 实时监控
- **实时日志流**: 实时显示最新日志
- **告警面板**: 异常日志告警
- **状态监控**: 服务健康状态

## 8. 部署架构

### 8.1 Docker部署

#### 服务配置
```yaml
services:
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    environment:
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - discovery.type=single-node
      - xpack.security.enabled=false
    
  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - xpack.security.enabled=false
    
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    volumes:
      - ./logs:/var/log/app:ro
```

### 8.2 网络架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        网络架构                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  主机网络     │    │  Docker网络   │    │  容器网络     │
│             │    │             │    │             │
│ 10.0.1.0/24 │    │ 172.20.0.0/16│    │ elk-network │
│             │    │             │    │             │
│ - 应用服务    │    │ - ELK服务     │    │ - 内部通信     │
│ - 日志文件    │    │ - 数据卷      │    │ - 服务发现     │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 9. 性能优化

### 9.1 系统优化

#### Elasticsearch优化
- **内存配置**: 512MB堆内存
- **索引优化**: 单分片，无副本
- **刷新间隔**: 5秒刷新，平衡实时性和性能
- **缓存配置**: 合理配置查询缓存

#### Filebeat优化
- **批量大小**: 1000条批量发送
- **缓冲区**: 4KB读取缓冲区
- **扫描频率**: 10秒扫描间隔
- **队列配置**: 内存队列，4096事件

### 9.2 查询优化

#### 索引优化
- **字段映射**: 合理设置字段类型
- **分词器**: 使用合适的分词器
- **索引模板**: 统一索引配置

#### 查询优化
- **时间范围**: 限制查询时间范围
- **字段过滤**: 使用字段过滤减少数据传输
- **聚合优化**: 合理使用聚合查询

## 10. 监控和维护

### 10.1 健康监控

#### 服务监控
```bash
# Elasticsearch健康检查
curl http://localhost:9200/_cluster/health

# Kibana状态检查
curl http://localhost:5601/api/status

# Filebeat状态检查
docker logs elk-filebeat
```

#### 性能监控
```bash
# 节点状态
curl http://localhost:9200/_nodes/stats

# 索引统计
curl http://localhost:9200/_stats

# 查询性能
curl http://localhost:9200/_nodes/stats/indices/search
```

### 10.2 维护操作

#### 日常维护
- **日志清理**: 定期清理过期索引
- **性能监控**: 监控查询性能
- **存储监控**: 监控磁盘使用情况
- **服务重启**: 定期重启服务

#### 故障处理
- **服务异常**: 检查容器状态和日志
- **性能问题**: 调整内存和配置参数
- **存储问题**: 清理数据和优化索引
- **网络问题**: 检查网络连接和端口

## 11. 安全考虑

### 11.1 基础安全

#### 网络安全
- **端口限制**: 只开放必要端口
- **防火墙**: 配置防火墙规则
- **内网访问**: 限制外网访问

#### 数据安全
- **敏感信息**: 自动脱敏处理
- **访问控制**: 限制数据访问权限
- **审计日志**: 记录访问日志

### 11.2 生产环境安全

#### 安全加固
- **启用认证**: 生产环境启用用户认证
- **SSL加密**: 启用HTTPS传输加密
- **访问控制**: 配置IP白名单
- **定期备份**: 定期备份重要数据

## 12. 扩展方案

### 12.1 水平扩展

#### 集群扩展
- **多节点ES**: 升级为多节点集群
- **负载均衡**: 添加负载均衡器
- **数据分片**: 增加数据分片数量

#### 功能扩展
- **告警系统**: 集成AlertManager
- **监控系统**: 集成Prometheus
- **可视化**: 集成Grafana

### 12.2 垂直扩展

#### 资源升级
- **内存升级**: 增加内存配置
- **存储升级**: 使用SSD存储
- **网络升级**: 升级网络带宽

#### 功能增强
- **安全功能**: 启用完整安全功能
- **高级分析**: 添加机器学习功能
- **多租户**: 支持多租户隔离

## 13. 成本分析

### 13.1 资源成本

#### 开发环境
- **内存**: 1.1GB
- **存储**: 2.5GB
- **CPU**: 2核心
- **成本**: 极低

#### 生产环境
- **内存**: 4GB（推荐）
- **存储**: 50GB
- **CPU**: 4核心
- **成本**: 中等

### 13.2 运维成本

#### 部署成本
- **部署时间**: 5分钟
- **配置复杂度**: 低
- **学习成本**: 低

#### 维护成本
- **日常维护**: 30分钟/周
- **故障处理**: 1小时/月
- **升级成本**: 低

## 14. 总结

### 14.1 方案优势

1. **轻量级**: 资源占用少，适合开发环境
2. **简单易用**: 一键部署，开箱即用
3. **成本低廉**: 硬件要求低，运维成本少
4. **功能完整**: 满足基本日志管理需求
5. **易于扩展**: 支持后续功能扩展

### 14.2 适用场景

- **开发环境**: 开发测试阶段的日志管理
- **小规模生产**: 中小型应用的日志管理
- **原型验证**: 快速验证日志管理方案
- **学习研究**: 学习ELK技术栈

### 14.3 后续规划

1. **功能增强**: 添加告警、监控功能
2. **性能优化**: 优化查询和存储性能
3. **安全加固**: 添加安全认证功能
4. **集群扩展**: 升级为高可用集群

本方案提供了一个完整的轻量级ELK日志纳管解决方案，既满足了当前的日志管理需求，又为后续的功能扩展留下了空间。
