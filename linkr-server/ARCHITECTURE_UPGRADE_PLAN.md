# MetaLinkr 日志系统架构升级计划

## 当前架构问题

### 1. 服务职责混乱
- **log-module** 同时承担实时推送和查询统计两个职责
- 实时写入和复杂查询相互影响性能
- 无法针对不同需求独立优化和扩展

### 2. 具体问题
- 数据库压力：实时写入和复杂查询同时进行
- 扩展性问题：实时推送和查询的扩展需求不同
- 维护复杂性：职责不清，代码耦合度高

## 架构升级计划

### 阶段一：服务拆分（当前执行）
**目标**: 将log-module拆分为两个独立服务

#### 1.1 服务拆分方案
```
┌─────────────────┐    ┌─────────────────┐
│  log-query-api  │    │ log-realtime-api│
│   (查询服务)     │    │  (实时推送服务)  │
└─────────────────┘    └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌─────────────────┐
│   MySQL         │    │   WebSocket     │
│   (查询库)       │    │   (实时推送)     │
└─────────────────┘    └─────────────────┘
```

#### 1.2 接口设计
- **查询服务接口**: `/api/logs/query/*` - 负责日志查询、统计、分析
- **实时推送接口**: `/api/logs/realtime/*` - 负责WebSocket连接和实时推送

#### 1.3 数据流
```
admin-module → Kafka → log-realtime-api → WebSocket → 前端
                    ↓
                log-query-api → MySQL → 前端查询
```

### 阶段二：引入Elasticsearch（后续规划）
**目标**: 使用ES作为日志搜索引擎，提升查询性能

#### 2.1 架构升级
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  log-collector  │    │  log-query-api  │    │ log-realtime-api│
│   (日志收集)     │    │   (查询服务)     │    │  (实时推送服务)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Kafka         │    │ Elasticsearch   │    │   WebSocket     │
│   (消息队列)     │    │   (搜索引擎)     │    │   (实时推送)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
            ┌─────────────┐         ┌─────────────┐
            │   MySQL     │         │    Redis    │
            │  (元数据)    │         │  (缓存)     │
            └─────────────┘         └─────────────┘
```

#### 2.2 技术栈升级
- **Elasticsearch**: 日志存储和搜索
- **Kibana**: 日志可视化和分析
- **Redis**: 实时推送缓存和会话管理
- **Logstash**: 日志处理和转换

#### 2.3 功能增强
- 全文搜索和复杂查询
- 日志聚合和统计分析
- 实时监控和告警
- 日志可视化仪表板

### 阶段三：微服务架构（长期规划）
**目标**: 完整的微服务架构，支持高并发和大规模部署

#### 3.1 服务拆分
- **log-collector**: 日志收集服务
- **log-processor**: 日志处理服务
- **log-query-api**: 日志查询API服务
- **log-realtime-api**: 实时推送API服务
- **log-alert-service**: 告警服务
- **log-analytics-service**: 分析服务

#### 3.2 基础设施
- **服务注册发现**: Nacos
- **配置中心**: Nacos Config
- **API网关**: Spring Cloud Gateway
- **负载均衡**: Ribbon/Spring Cloud LoadBalancer
- **熔断器**: Hystrix/Sentinel
- **链路追踪**: Sleuth + Zipkin

## 实施时间表

### 当前版本 (v1.0)
- [x] 基础日志收集架构
- [x] Kafka消息队列
- [x] WebSocket实时推送
- [ ] 服务拆分（进行中）

### 下一版本 (v1.1)
- [ ] 完成服务拆分
- [ ] 优化查询性能
- [ ] 完善监控告警

### 未来版本 (v2.0)
- [ ] 引入Elasticsearch
- [ ] 实现日志可视化
- [ ] 完善微服务架构

## 技术选型

### 当前技术栈
- **Spring Boot 2.7.18**
- **Spring Cloud 2021.0.8**
- **Spring Cloud Alibaba 2021.0.5.0**
- **MySQL 8.0**
- **Kafka 2.8**
- **WebSocket**
- **MyBatis Plus**

### 升级后技术栈
- **Elasticsearch 8.x**
- **Kibana 8.x**
- **Redis 6.x**
- **Logstash 8.x**
- **Spring Cloud Gateway**
- **Nacos 2.x**

## 性能目标

### 当前性能
- 日志写入: ~1000条/秒
- 查询响应: ~500ms
- 实时推送延迟: ~100ms

### 升级后性能目标
- 日志写入: ~10000条/秒
- 查询响应: ~100ms
- 实时推送延迟: ~50ms
- 支持TB级日志存储

## 风险评估

### 技术风险
- ES集群维护复杂度
- 数据迁移风险
- 性能调优挑战

### 业务风险
- 服务拆分可能影响现有功能
- 升级过程中的服务中断
- 数据一致性保证

### 缓解措施
- 分阶段实施，逐步迁移
- 完善的测试和回滚方案
- 监控和告警机制
- 文档和培训

## 总结

本升级计划将分三个阶段实施：
1. **服务拆分**: 解决当前架构问题，提升可维护性
2. **引入ES**: 提升查询性能和功能丰富度
3. **微服务架构**: 支持大规模部署和高可用

每个阶段都有明确的目标和可衡量的成果，确保系统架构的持续演进和优化。
